<!DOCTYPE html>
<html lang="ru">
<head>
  <!-- ... (остальная часть head без изменений) ... -->
</head>
<body>
  <!-- ... (все HTML без изменений до скрипта) ... -->

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    
    const supabaseUrl = 'https://qmnnbotyzwftlhwakbnz.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtbm5ib3R5endmdGxod2FrYm56Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwOTE3MzYsImV4cCI6MjA2NzY2NzczNn0.QaHkN4M4_Deh4HN4CZ-spv8QKbGKzhrfGwMvr6Pbyv4'
    const supabase = createClient(supabaseUrl, supabaseKey)
    
    // Состояние
    let isAdmin = false
    const ADMIN_PASSWORD = "erema"
    let selectedCategory = "all"
    let allProducts = []
    
    document.addEventListener('DOMContentLoaded', () => {
      loadProducts()
      setupEventListeners()
    })
    
    async function loadProducts() {
      try {
        const { data, error } = await supabase
          .from('products')
          .select('*')
          .order('order', { ascending: true })
        
        if (error) throw error
        
        allProducts = data || []
        updateCategories()
        renderProducts()
      } catch (error) {
        console.error('Ошибка загрузки товаров:', error)
        alert('Ошибка загрузки товаров. Проверьте консоль.')
      }
    }
    
    function updateCategories() {
      const categories = [...new Set(allProducts.map(p => p.category).filter(Boolean))]
      const container = document.getElementById('categories')
      
      const allButton = container.querySelector('[data-category="all"]')
      container.innerHTML = ''
      container.appendChild(allButton)
      
      categories.forEach(cat => {
        const btn = document.createElement('button')
        btn.className = 'category-btn'
        btn.dataset.category = cat
        btn.textContent = cat
        btn.addEventListener('click', () => {
          selectedCategory = cat
          document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'))
          btn.classList.add('active')
          renderProducts()
        })
        container.appendChild(btn)
      })
    }
    
    function renderProducts() {
      const activeProducts = allProducts.filter(p => 
        !p.archived && (selectedCategory === "all" || p.category === selectedCategory)
      )
      
      const archivedProducts = allProducts.filter(p => p.archived)
      
      // Исправленное форматирование цены
      const productsGrid = document.getElementById('productsGrid')
      productsGrid.innerHTML = activeProducts.map(product => `
        <div class="product-card" data-id="${product.id}">
          <img src="${product.img || 'https://via.placeholder.com/150'}" class="product-image">
          <div class="product-name" contenteditable="${isAdmin}" onblur="updateProduct(${product.id}, 'name', this.textContent)">${product.name}</div>
          <div class="product-price" contenteditable="${isAdmin}" onblur="updateProduct(${product.id}, 'price', this.textContent)">
            ${formatPrice(product.price)}
          </div>
          
          ${isAdmin ? `
            <div class="admin-controls">
              <button class="delete-btn" onclick="archiveProduct('${product.id}')">Архив</button>
              <button class="delete-btn" onclick="deleteProduct('${product.id}')">Удалить</button>
            </div>
            <div class="move-btns">
              <button onclick="moveProduct('${product.id}', 'up')">↑</button>
              <button onclick="moveProduct('${product.id}', 'down')">↓</button>
            </div>
          ` : ''}
        </div>
      `).join('')
      
      if (isAdmin) {
        const archiveGrid = document.getElementById('archiveGrid')
        archiveGrid.innerHTML = archivedProducts.map(product => `
          <div class="product-card" data-id="${product.id}">
            <img src="${product.img || 'https://via.placeholder.com/150'}" class="product-image">
            <div class="product-name">${product.name}</div>
            <div class="product-price">${formatPrice(product.price)}</div>
            <div class="admin-controls">
              <button class="archive-btn" onclick="restoreProduct('${product.id}')">Восстановить</button>
              <button class="delete-btn" onclick="deleteProduct('${product.id}')">Удалить</button>
            </div>
          </div>
        `).join('')
      }
    }
    
    // Новая функция для форматирования цены
    window.formatPrice = (price) => {
      return (price || 0).toLocaleString('ru-RU') + ' ₸'
    }
    
    function setupEventListeners() {
      document.getElementById('adminAccess').addEventListener('click', toggleAdminMode)
      document.getElementById('addProductBtn').addEventListener('click', addNewProduct)
      document.querySelector('[data-category="all"]').addEventListener('click', () => {
        selectedCategory = "all"
        document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'))
        document.querySelector('[data-category="all"]').classList.add('active')
        renderProducts()
      })
    }
    
    async function toggleAdminMode() {
      if (isAdmin) {
        isAdmin = false
        document.body.classList.remove('admin-visible')
      } else {
        const password = prompt('Введите пароль администратора:')
        if (password === ADMIN_PASSWORD) {
          isAdmin = true
          document.body.classList.add('admin-visible')
          renderProducts()
        } else {
          alert('Неверный пароль!')
        }
      }
    }
    
    async function addNewProduct() {
      const name = document.getElementById('productName').value
      let price = document.getElementById('productPrice').value
      const img = document.getElementById('productImage').value
      const category = document.getElementById('productCategory').value
      
      // Очистка цены (новый код)
      price = parseInt(price.replace(/[^\d]/g, '')) || 0
      
      if (!name || !category) {
        alert('Заполните название и категорию!')
        return
      }
      
      try {
        const { error } = await supabase
          .from('products')
          .insert([{ 
            name, 
            price, 
            img: img || 'https://via.placeholder.com/150',
            category,
            archived: false,
            order: allProducts.length + 1
          }])
        
        if (error) throw error
        
        document.getElementById('productName').value = ''
        document.getElementById('productPrice').value = ''
        document.getElementById('productImage').value = ''
        document.getElementById('productCategory').value = ''
        
        await loadProducts()
      } catch (error) {
        console.error('Ошибка добавления товара:', error)
        alert('Ошибка при добавлении товара.')
      }
    }
    
    // Обновленная функция updateProduct
    window.updateProduct = async (id, field, value) => {
      try {
        let updateValue = field === 'price' 
          ? parseInt(value.replace(/[^\d]/g, '')) || 0
          : value
        
        const { error } = await supabase
          .from('products')
          .update({ [field]: updateValue })
          .eq('id', id)
        
        if (error) throw error
        
        const productIndex = allProducts.findIndex(p => p.id === id)
        if (productIndex !== -1) {
          allProducts[productIndex][field] = updateValue
          renderProducts() // Обновляем отображение
        }
      } catch (error) {
        console.error('Ошибка обновления:', error)
        alert('Ошибка при сохранении. Проверьте консоль.')
        loadProducts()
      }
    }
    
    // ... (остальные функции archiveProduct, restoreProduct, deleteProduct, moveProduct без изменений) ...
  </script>
</body>
</html>
