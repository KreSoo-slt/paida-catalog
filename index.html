<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paida All ‚Äî –ö–∞—Ç–∞–ª–æ–≥</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 1em;
    }
    header {
      background: #ffffff;
      padding: 1em;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.5em;
    }
    header .contact {
      font-size: 0.9em;
      color: #444;
      margin-top: 0.5em;
    }
    .notice {
      background-color: #fff0c4;
      color: #5c4a00;
      padding: 0.8em;
      margin: 1em 0;
      border-left: 5px solid #ffd700;
    }
    .search-box {
      text-align: center;
      margin-bottom: 1em;
    }
    .search-box input {
      width: 90%;
      padding: 0.6em;
      font-size: 1em;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .whatsapp-link {
      position: fixed;
      top: 1em;
      right: 1em;
      background-color: #25D366;
      color: white;
      padding: 0.6em 1em;
      border-radius: 5px;
      text-decoration: none;
      font-weight: bold;
      z-index: 999;
    }
    .cards-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1em;
      justify-content: center;
    }
    .card {
      background: white;
      border-radius: 10px;
      padding: 1em;
      width: 160px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    .card img {
      max-width: 120px;
      height: auto;
      border-radius: 8px;
      cursor: zoom-in;
    }
    .title {
      font-size: 1em;
      font-weight: bold;
      margin: 0.5em 0;
    }
    .price {
      color: green;
      font-weight: bold;
      font-size: 1.1em;
    }
    .admin-panel, .admin-indicator {
      display: none;
    }
    .admin-visible .admin-panel,
    .admin-visible .admin-indicator {
      display: block;
    }
    .admin-toggle {
      position: fixed;
      bottom: 6em;
      left: 1em;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 0.4em 0.8em;
      cursor: pointer;
      z-index: 999;
    }
    .category-section {
      margin: 1em 0;
    }
    .category-title {
      font-size: 1.2em;
      margin: 0.5em 0;
      font-weight: bold;
    }
    .admin-indicator {
      font-size: 0.8em;
      color: red;
      text-align: center;
      margin-bottom: 0.5em;
    }
    .filter-bar {
      display: flex;
      gap: 0.5em;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 1em;
    }
    .filter-bar button {
      padding: 0.4em 0.8em;
      border-radius: 5px;
      border: 1px solid #ccc;
      cursor: pointer;
    }
    .move-btns {
      display: flex;
      gap: 5px;
      margin-top: 4px;
    }
    .move-btns button {
      font-size: 0.8em;
      padding: 2px 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <a class="whatsapp-link" href="https://wa.me/77780855478" target="_blank">üí¨ WhatsApp ‚Äî –î–ª—è –∑–∞–∫–∞–∑–∞</a>
  <button class="admin-toggle" onclick="toggleAdmin()">–í–æ–π—Ç–∏ –∫–∞–∫ –∞–¥–º–∏–Ω</button>

  <header>
    <h1>Paida All</h1>
    <div class="contact">
      –≥. –ö–∞—Ä–∞–≥–∞–Ω–¥–∞, —É–ª. –ê–ª–∏—Ö–∞–Ω–æ–≤–∞ 37 (—Ü–æ–∫–æ–ª—å–Ω—ã–π —ç—Ç–∞–∂) <br>
      –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: 13:00‚Äì20:00 <br>
      –¢–µ–ª: 8 (778) 085-54-78
    </div>
  </header>

  <div class="notice">
    –ó–∞–∫–∞–∑—ã –ø–æ—Å–ª–µ 13:00 –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å. <br>
    –î–æ—Å—Ç–∞–≤–∫–∞ –∏ —Å–∞–º–æ–≤—ã–≤–æ–∑ –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ –ö–∞—Ä–∞–≥–∞–Ω–¥–µ.
  </div>

  <div class="admin-indicator">üîí –í–∏–¥–Ω–æ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É</div>

  <div class="search-box">
    <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." oninput="searchProducts()">
  </div>

  <div class="filter-bar" id="filterBar"></div>

  <div id="categories"></div>

  <div class="admin-panel">
    <h3>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h3>
    <input type="text" id="nameInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
    <input type="text" id="priceInput" placeholder="–¶–µ–Ω–∞">
    <input type="text" id="imgInput" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ">
    <input type="text" id="catInput" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è">
    <button onclick="addProduct()">–î–æ–±–∞–≤–∏—Ç—å</button>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const supabaseUrl = 'https://qmnnbotyzwftlhwakbnz.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtbm5ib3R5endmdGxod2FrYm56Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwOTE3MzYsImV4cCI6MjA2NzY2NzczNn0.QaHkN4M4_Deh4HN4CZ-spv8QKbGKzhrfGwMvr6Pbyv4'
    const supabase = createClient(supabaseUrl, supabaseKey)

    let isAdmin = false;
    const password = "erema";
    let products = [];
    let archive = [];
    let selectedCategory = "–í—Å–µ";

    async function fetchProducts() {
      const { data, error } = await supabase
        .from('products')
        .select('*')
        .order('order', { ascending: true });

      if (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
        return;
      }

      products = data.filter(p => !p.archived);
      archive = data.filter(p => p.archived);
      render();
    }

    async function moveProduct(productId, direction) {
      const currentProduct = products.find(p => p.id === productId);
      const categoryProducts = products
        .filter(p => p.category === currentProduct.category)
        .sort((a, b) => a.order - b.order);

      const currentIndex = categoryProducts.findIndex(p => p.id === productId);
      
      if (
        (direction === 'up' && currentIndex === 0) ||
        (direction === 'down' && currentIndex === categoryProducts.length - 1)
      ) return;

      const swapIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
      const swapProduct = categoryProducts[swapIndex];

      await supabase
        .from('products')
        .update({ order: swapProduct.order })
        .eq('id', currentProduct.id);

      await supabase
        .from('products')
        .update({ order: currentProduct.order })
        .eq('id', swapProduct.id);

      fetchProducts();
    }

    function render() {
      const catMap = {};
      products.forEach(p => {
        if (!catMap[p.category]) catMap[p.category] = [];
        catMap[p.category].push(p);
      });

      const sortedCats = Object.keys(catMap).sort();
      const filterBar = document.getElementById("filterBar");
      filterBar.innerHTML = '';
      const allBtn = document.createElement("button");
      allBtn.innerText = "–í—Å–µ";
      allBtn.onclick = () => { selectedCategory = "–í—Å–µ"; render(); };
      filterBar.appendChild(allBtn);

      sortedCats.forEach(cat => {
        const btn = document.createElement("button");
        btn.innerText = cat;
        btn.onclick = () => { selectedCategory = cat; render(); };
        filterBar.appendChild(btn);
      });

      const container = document.getElementById("categories");
      container.innerHTML = "";

      sortedCats.forEach(cat => {
        if (selectedCategory !== "–í—Å–µ" && cat !== selectedCategory) return;
        const section = document.createElement("div");
        section.className = "category-section";
        section.innerHTML = `<div class="category-title">${cat}</div>`;
        const wrap = document.createElement("div");
        wrap.className = "cards-container";

        catMap[cat].forEach((p, i) => {
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <img src="${p.img || 'https://via.placeholder.com/120'}" onclick="window.open('${p.img || 'https://via.placeholder.com/120'}')">
            <div class="title" contenteditable="${isAdmin}" onblur="updateProduct(${p.id}, 'name', this.innerText)">${p.name}</div>
            <div class="price" contenteditable="${isAdmin}" onblur="updateProduct(${p.id}, 'price', this.innerText.replace(/[^\d]/g, ''))">${p.price} ‚Ç∏</div>
            ${isAdmin ? `<button onclick="archiveProduct(${p.id}, true)">–ê—Ä—Ö–∏–≤</button>` : ""}
            ${isAdmin ? `<button onclick="deleteProduct(${p.id})">–£–¥–∞–ª–∏—Ç—å</button>` : ""}
            ${isAdmin ? `<div class="move-btns"><button onclick="moveProduct(${p.id}, 'up')">‚ñ≤</button><button onclick="moveProduct(${p.id}, 'down')">‚ñº</button></div>` : ""}
          `;
          wrap.appendChild(card);
        });
        section.appendChild(wrap);
        container.appendChild(section);
      });

      if (isAdmin && archive.length > 0) {
        const archBlock = document.createElement("div");
        archBlock.className = "category-section";
        archBlock.innerHTML = `<div class="category-title">üì¶ –ê—Ä—Ö–∏–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)</div>`;
        const wrap = document.createElement("div");
        wrap.className = "cards-container";
        archive.forEach(p => {
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <img src="${p.img || 'https://via.placeholder.com/120'}">
            <div class="title">${p.name}</div>
            <div class="price">${p.price} ‚Ç∏</div>
            <button onclick="archiveProduct(${p.id}, false)">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            <button onclick="deleteProduct(${p.id})">–£–¥–∞–ª–∏—Ç—å</button>
          `;
          wrap.appendChild(card);
        });
        archBlock.appendChild(wrap);
        container.appendChild(archBlock);
      }
    }

    async function addProduct() {
      const name = document.getElementById("nameInput").value;
      const price = document.getElementById("priceInput").value;
      const img = document.getElementById("imgInput").value || "https://via.placeholder.com/120";
      const category = document.getElementById("catInput").value || "–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏";

      if (!name || !price) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");

      const { data, error } = await supabase
        .from('products')
        .insert([{ 
          name, 
          price, 
          img, 
          category,
          archived: false,
          order: products.length + 1
        }])
        .select();

      if (error) {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞: " + error.message);
      } else {
        document.getElementById("nameInput").value = "";
        document.getElementById("priceInput").value = "";
        document.getElementById("imgInput").value = "";
        document.getElementById("catInput").value = "";
        fetchProducts();
      }
    }

    async function updateProduct(id, field, value) {
      const { error } = await supabase
        .from('products')
        .update({ [field]: value })
        .eq('id', id);

      if (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
        fetchProducts();
      }
    }

    async function archiveProduct(id, archiveStatus) {
      const { error } = await supabase
        .from('products')
        .update({ archived: archiveStatus })
        .eq('id', id);

      if (!error) {
        fetchProducts();
      }
    }

    async function deleteProduct(id) {
      if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?")) {
        const { error } = await supabase
          .from('products')
          .delete()
          .eq('id', id);

        if (!error) {
          fetchProducts();
        }
      }
    }

    function toggleAdmin() {
      const userPass = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:");
      if (userPass === password) {
        isAdmin = true;
        document.body.classList.add("admin-visible");
        render();
      } else {
        alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
      }
    }

    function searchProducts() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      if (searchTerm === '') {
        fetchProducts();
      } else {
        products = products.filter(p => 
          p.name.toLowerCase().includes(searchTerm)
        render();
      }
    }

    // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏
    window.moveProduct = moveProduct;
    window.archiveProduct = archiveProduct;
    window.deleteProduct = deleteProduct;
    window.updateProduct = updateProduct;
    window.toggleAdmin = toggleAdmin;
    window.searchProducts = searchProducts;

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    fetchProducts();
  </script>
</body>
</html>
