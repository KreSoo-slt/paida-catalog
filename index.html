<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Paida All — Каталог</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <style>
    :root {
      --primary-color: #25D366;
      --admin-color: #ff4757;
    }

    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 0;
    }

    .main-header {
      background: white;
      padding: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .logo {
      height: 50px;
    }

    .products-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }

    .product-card {
      background: #fff;
      border-radius: 10px;
      padding: 1rem;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }

    .product-image {
      width: 100%;
      height: 180px;
      object-fit: contain;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 10px;
    }

    .categories, .types {
      display: flex;
      overflow-x: auto;
      gap: 10px;
      padding: 10px;
      background: white;
      margin-bottom: 10px;
    }

    .category-btn, .type-btn {
      padding: 6px 14px;
      border: none;
      border-radius: 20px;
      background: #f1f1f1;
      cursor: pointer;
    }

    .category-btn.active, .type-btn.active {
      background: var(--primary-color);
      color: white;
    }

    .admin-panel {
      margin-top: 2rem;
      background: #fff;
      padding: 1rem;
      border-radius: 10px;
      display: none;
    }

    .admin-visible .admin-panel {
      display: block;
    }
  </style>
</head>
<body>
  <header class="main-header">
    <div class="container">
      <h1>Paida All</h1>
      <button id="adminAccess">Для админа</button>
    </div>
  </header>

  <div class="categories" id="categories">
    <button class="category-btn active" data-category="all">Все производители</button>
  </div>

  <div class="types" id="types">
    <button class="type-btn active" data-type="all">Все типы</button>
  </div>

  <main class="container">
    <div class="products-list" id="productsList"></div>

    <div class="admin-panel" id="adminPanel">
      <h2>Добавить товар</h2>
      <input type="text" id="productName" placeholder="Название товара" />
      <input type="number" id="productPrice" placeholder="Цена" />
      <input type="text" id="productImage" placeholder="Ссылка на изображение" />
      <input type="text" id="productCategory" placeholder="Производитель" />
      <input type="text" id="productType" placeholder="Тип (мыло, порошок и т.д.)" />
      <textarea id="productDescription" placeholder="Описание"></textarea>
      <button id="addProductBtn">Добавить</button>
    </div>
  </main>
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  const supabase = createClient(
    import.meta.env.SUPABASE_URL,
    import.meta.env.SUPABASE_KEY
  )

  const ADMIN_PASSWORD = import.meta.env.ADMIN_PASSWORD
  const TELEGRAM_BOT_TOKEN = import.meta.env.TELEGRAM_BOT_TOKEN
  const TELEGRAM_CHAT_ID = import.meta.env.TELEGRAM_CHAT_ID

  let isAdmin = false
  let selectedCategory = "all"
  let selectedType = "all"
  let allProducts = []

  document.getElementById('adminAccess').addEventListener('click', async () => {
    const pass = prompt('Введите пароль администратора:')
    if (pass === ADMIN_PASSWORD) {
      isAdmin = true
      document.body.classList.add('admin-visible')
      renderProducts()
    } else {
      alert('Неверный пароль!')
    }
  })

  async function logAdminAction(text) {
    try {
      await supabase.from('admin_logs').insert([{ action: text }])
      await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${encodeURIComponent(text)}`)
    } catch (err) {
      console.warn('Ошибка логирования', err)
    }
  }

  async function loadProducts() {
    const { data, error } = await supabase.from('products').select('*').order('order')
    if (error) {
      alert('Ошибка загрузки товаров')
      return
    }
    allProducts = data
    renderFilters()
    renderProducts()
  }

  function renderFilters() {
    const cats = [...new Set(allProducts.map(p => p.category).filter(Boolean))]
    const container = document.getElementById('categories')
    container.innerHTML = ''
    const allBtn = document.createElement('button')
    allBtn.className = 'category-btn active'
    allBtn.dataset.category = 'all'
    allBtn.textContent = 'Все производители'
    allBtn.onclick = () => {
      selectedCategory = 'all'
      document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'))
      allBtn.classList.add('active')
      renderProducts()
    }
    container.appendChild(allBtn)

    cats.forEach(cat => {
      const btn = document.createElement('button')
      btn.className = 'category-btn'
      btn.dataset.category = cat
      btn.textContent = cat
      btn.onclick = () => {
        selectedCategory = cat
        document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'))
        btn.classList.add('active')
        renderProducts()
      }
      container.appendChild(btn)
    })

    const types = [...new Set(allProducts.map(p => p.type).filter(Boolean))]
    const typeCont = document.getElementById('types')
    typeCont.innerHTML = ''
    const allTypeBtn = document.createElement('button')
    allTypeBtn.className = 'type-btn active'
    allTypeBtn.dataset.type = 'all'
    allTypeBtn.textContent = 'Все типы'
    allTypeBtn.onclick = () => {
      selectedType = 'all'
      document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'))
      allTypeBtn.classList.add('active')
      renderProducts()
    }
    typeCont.appendChild(allTypeBtn)

    types.forEach(type => {
      const btn = document.createElement('button')
      btn.className = 'type-btn'
      btn.dataset.type = type
      btn.textContent = type
      btn.onclick = () => {
        selectedType = type
        document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'))
        btn.classList.add('active')
        renderProducts()
      }
      typeCont.appendChild(btn)
    })
  }

  function renderProducts() {
    const filtered = allProducts.filter(p =>
      !p.archived &&
      (selectedCategory === "all" || p.category === selectedCategory) &&
      (selectedType === "all" || p.type === selectedType)
    )

    const container = document.getElementById('productsList')
    container.innerHTML = filtered.map(p => `
      <div class="product-card" data-id="${p.id}">
        <img src="${p.img || 'https://via.placeholder.com/150'}" class="product-image" onclick="changeImage('${p.id}', this)">
        <strong>${p.name}</strong>
        <p>${p.description}</p>
        <b>${(p.price || 0).toLocaleString('ru-RU')} ₸</b>
      </div>
    `).join('')
  }

  window.changeImage = async (id, imgEl) => {
    if (!isAdmin) return
    const newUrl = prompt('Введите новую ссылку на изображение:')
    if (!newUrl) return
    await supabase.from('products').update({ img: newUrl }).eq('id', id)
    imgEl.src = newUrl
    logAdminAction(`Изображение товара ${id} обновлено`)
  }

  document.getElementById('addProductBtn').addEventListener('click', async () => {
    const name = document.getElementById('productName').value
    const price = parseInt(document.getElementById('productPrice').value)
    const img = document.getElementById('productImage').value
    const category = document.getElementById('productCategory').value
    const type = document.getElementById('productType').value
    const description = document.getElementById('productDescription').value

    if (!name || !category || !type) {
      alert('Заполните все обязательные поля!')
      return
    }

    await supabase.from('products').insert([{
      name, price, img, category, type, description, archived: false, order: allProducts.length + 1
    }])
    logAdminAction(`Добавлен товар: ${name}`)
    loadProducts()
  })

  loadProducts()
</script>
</body>
</html>
