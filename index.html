<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>Paida All ‚Äî –ö–∞—Ç–∞–ª–æ–≥</title>
  <style>
    /* –í—Å–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
    :root {
      --primary-color: #25D366;
      --admin-color: #ff4757;
      --notice-color: #fff0c4;
    }
    /* ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ ... */
  </style>
</head>
<body>
  <!-- HTML —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
  <!-- ... -->

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
const supabaseUrl = 'https://qmnnbotyzwftlhwakbnz.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtbm5ib3R5endmdGxod2FrYm56Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwOTE3MzYsImV4cCI6MjA2NzY2NzczNn0.QaHkN4M4_Deh4HN4CZ-spv8QKbGKzhrfGwMvr6Pbyv4'
const supabase = createClient(supabaseUrl, supabaseKey)

// Telegram
const TELEGRAM_BOT_TOKEN = '7673591792:AAFQ83r98YSJay_X81HZIMh2cowWQu1bgGc'
const TELEGRAM_CHAT_ID = '1182976777'

// –°–æ—Å—Ç–æ—è–Ω–∏–µ
let isAdmin = false
let selectedCategory = "all"
let allProducts = []
let adminPassword = null

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', () => {
  loadProducts()
  setupEventListeners()
  setupModal()
})

// –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–∞—Ä–æ–ª—è
function setupModal() {
  const modal = document.getElementById('passwordModal')
  const confirmBtn = document.getElementById('confirmPassword')
  const cancelBtn = document.getElementById('cancelPassword')
  const passwordInput = document.getElementById('passwordInput')
  
  document.getElementById('adminAccess').addEventListener('click', () => {
    if (isAdmin) {
      isAdmin = false
      document.body.classList.remove('admin-visible')
      sendTelegramLog('üî¥ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤—ã—à–µ–ª –∏–∑ —Å–∏—Å—Ç–µ–º—ã')
    } else {
      modal.style.display = 'block'
    }
  })
  
  confirmBtn.addEventListener('click', () => {
    const password = passwordInput.value.trim()
    if (password) {
      adminPassword = password
      isAdmin = true
      document.body.classList.add('admin-visible')
      modal.style.display = 'none'
      passwordInput.value = ''
      sendTelegramLog('üü¢ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É')
      renderProducts()
    }
  })
  
  cancelBtn.addEventListener('click', () => {
    modal.style.display = 'none'
    passwordInput.value = ''
  })
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –ª–æ–≥–æ–≤ –≤ Telegram
async function sendTelegramLog(message) {
  try {
    await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: TELEGRAM_CHAT_ID,
        text: message
      })
    })
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–∞:', error)
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
async function loadProducts() {
  try {
    const { data, error } = await supabase
      .from('products')
      .select('*')
      .order('order', { ascending: true })
    
    if (error) throw error
    
    allProducts = data || []
    updateCategories()
    renderProducts()
    sendTelegramLog(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allProducts.length} —Ç–æ–≤–∞—Ä–æ–≤`)
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error)
    sendTelegramLog(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`)
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
function updateCategories() {
  const categories = [...new Set(allProducts.map(p => p.category).filter(Boolean))]
  const container = document.getElementById('categories')
  
  const allButton = container.querySelector('[data-category="all"]')
  container.innerHTML = ''
  container.appendChild(allButton)
  
  categories.forEach(cat => {
    const btn = document.createElement('button')
    btn.className = 'category-btn'
    btn.dataset.category = cat
    btn.textContent = cat
    btn.addEventListener('click', () => {
      selectedCategory = cat
      document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'))
      btn.classList.add('active')
      renderProducts()
    })
    container.appendChild(btn)
  })
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
function renderProducts() {
  const activeProducts = allProducts.filter(p => 
    !p.archived && (selectedCategory === "all" || p.category === selectedCategory)
  )
  const archivedProducts = allProducts.filter(p => p.archived)
  
  document.getElementById('productsGrid').innerHTML = activeProducts.map(product => `
    <div class="product-card" data-id="${product.id}">
      <img src="${product.img || 'https://via.placeholder.com/150'}" class="product-image">
      <div class="product-name" contenteditable="${isAdmin}" onblur="updateProductField(${product.id}, 'name', this.textContent)">${product.name}</div>
      <div class="product-price" contenteditable="${isAdmin}" onblur="updateProductPrice(${product.id}, this)">${product.price} ‚Ç∏</div>
      ${isAdmin ? `
        <div class="admin-controls">
          <button class="archive-btn" onclick="archiveProduct(${product.id})">–ê—Ä—Ö–∏–≤</button>
          <button class="delete-btn" onclick="deleteProduct(${product.id})">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
        <div class="move-btns">
          <button onclick="moveProduct(${product.id}, 'up')">‚Üë</button>
          <button onclick="moveProduct(${product.id}, 'down')">‚Üì</button>
        </div>
      ` : ''}
    </div>
  `).join('')
  
  if (isAdmin) {
    document.getElementById('archiveGrid').innerHTML = archivedProducts.map(product => `
      <div class="product-card" data-id="${product.id}">
        <img src="${product.img || 'https://via.placeholder.com/150'}" class="product-image">
        <div class="product-name">${product.name}</div>
        <div class="product-price">${product.price} ‚Ç∏</div>
        <div class="admin-controls">
          <button class="archive-btn" onclick="restoreProduct(${product.id})">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
          <button class="delete-btn" onclick="deleteProduct(${product.id})">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    `).join('')
  }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
window.updateProductField = async function(id, field, value) {
  try {
    const { error } = await supabase
      .from('products')
      .update({ [field]: value.trim() })
      .eq('id', id)
    
    if (error) throw error
    
    const product = allProducts.find(p => p.id === id)
    if (product) product[field] = value.trim()
    
    sendTelegramLog(`–û–±–Ω–æ–≤–ª–µ–Ω ${field} —Ç–æ–≤–∞—Ä–∞ ${id}`)
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error)
    sendTelegramLog(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ${field}: ${error.message}`)
    renderProducts()
  }
}

window.updateProductPrice = async function(id, element) {
  const newPrice = parseInt(element.textContent.replace(/[^\d]/g, '')) || 0
  
  if (newPrice <= 0) {
    const product = allProducts.find(p => p.id === id)
    element.textContent = product.price + ' ‚Ç∏'
    return
  }
  
  try {
    const { error } = await supabase
      .from('products')
      .update({ price: newPrice })
      .eq('id', id)
    
    if (error) throw error
    
    const product = allProducts.find(p => p.id === id)
    if (product) {
      product.price = newPrice
      element.textContent = newPrice + ' ‚Ç∏'
    }
    
    sendTelegramLog(`–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ü–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞ ${id}: ${newPrice} ‚Ç∏`)
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω—ã:', error)
    const product = allProducts.find(p => p.id === id)
    element.textContent = product.price + ' ‚Ç∏'
    sendTelegramLog(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω—ã: ${error.message}`)
  }
}

window.archiveProduct = async function(id) {
  if (!confirm('–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ç–æ–≤–∞—Ä –≤ –∞—Ä—Ö–∏–≤?')) return
  
  try {
    const { error } = await supabase
      .from('products')
      .update({ archived: true })
      .eq('id', id)
    
    if (error) throw error
    
    const product = allProducts.find(p => p.id === id)
    if (product) product.archived = true
    
    sendTelegramLog(`–¢–æ–≤–∞—Ä ${id} –ø–µ—Ä–µ–º–µ—â–µ–Ω –≤ –∞—Ä—Ö–∏–≤`)
    await loadProducts()
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏:', error)
    sendTelegramLog(`–û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏: ${error.message}`)
  }
}

window.restoreProduct = async function(id) {
  try {
    const { error } = await supabase
      .from('products')
      .update({ archived: false })
      .eq('id', id)
    
    if (error) throw error
    
    const product = allProducts.find(p => p.id === id)
    if (product) product.archived = false
    
    sendTelegramLog(`–¢–æ–≤–∞—Ä ${id} –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ –∞—Ä—Ö–∏–≤–∞`)
    await loadProducts()
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:', error)
    sendTelegramLog(`–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: ${error.message}`)
  }
}

window.deleteProduct = async function(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –Ω–∞–≤—Å–µ–≥–¥–∞?')) return
  
  try {
    const { error } = await supabase
      .from('products')
      .delete()
      .eq('id', id)
    
    if (error) throw error
    
    allProducts = allProducts.filter(p => p.id !== id)
    
    sendTelegramLog(`–¢–æ–≤–∞—Ä ${id} —É–¥–∞–ª–µ–Ω`)
    renderProducts()
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error)
    sendTelegramLog(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${error.message}`)
  }
}

window.moveProduct = async function(id, direction) {
  try {
    const product = allProducts.find(p => p.id === id)
    if (!product) return
    
    const categoryProducts = allProducts
      .filter(p => p.category === product.category && !p.archived)
      .sort((a, b) => a.order - b.order)
    
    const currentIndex = categoryProducts.findIndex(p => p.id === id)
    
    if (direction === 'up' && currentIndex > 0) {
      const prevProduct = categoryProducts[currentIndex - 1]
      
      await supabase
        .from('products')
        .update({ order: prevProduct.order })
        .eq('id', product.id)
      
      await supabase
        .from('products')
        .update({ order: product.order })
        .eq('id', prevProduct.id)
      
      await loadProducts()
    }
    else if (direction === 'down' && currentIndex < categoryProducts.length - 1) {
      const nextProduct = categoryProducts[currentIndex + 1]
      
      await supabase
        .from('products')
        .update({ order: nextProduct.order })
        .eq('id', product.id)
      
      await supabase
        .from('products')
        .update({ order: product.order })
        .eq('id', nextProduct.id)
      
      await loadProducts()
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è:', error)
  }
}

window.addNewProduct = async function() {
  const name = document.getElementById('productName').value.trim()
  const price = parseInt(document.getElementById('productPrice').value.replace(/[^\d]/g, '')) || 0
  const img = document.getElementById('productImage').value.trim()
  const category = document.getElementById('productCategory').value.trim()
  
  if (!name || !price || !category) {
    alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω—É –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é!")
    return
  }
  
  try {
    const { error } = await supabase
      .from('products')
      .insert([{ 
        name, 
        price, 
        img: img || 'https://via.placeholder.com/150',
        category,
        archived: false,
        order: allProducts.length + 1
      }])
    
    if (error) throw error
    
    document.getElementById('productName').value = ''
    document.getElementById('productPrice').value = ''
    document.getElementById('productImage').value = ''
    document.getElementById('productCategory').value = ''
    
    await loadProducts()
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:', error)
  }
}

function setupEventListeners() {
  document.getElementById('addProductBtn').addEventListener('click', addNewProduct)
  
  document.querySelector('[data-category="all"]').addEventListener('click', () => {
    selectedCategory = "all"
    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'))
    document.querySelector('[data-category="all"]').classList.add('active')
    renderProducts()
  })
}
</script>
</body>
</html>
