<div class="notice">
  –ó–∞–∫–∞–∑—ã –ø–æ—Å–ª–µ 13:00 –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å.<br>
  –î–æ—Å—Ç–∞–≤–∫–∞ –∏ —Å–∞–º–æ–≤—ã–≤–æ–∑ –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ –ö–∞—Ä–∞–≥–∞–Ω–¥–µ.
</div>

<div class="categories" id="categories">
  <button class="category-btn active" data-category="all">–í—Å–µ</button>
</div>

<div class="products-container">
  <div class="products-grid" id="productsGrid"></div>
</div>

<div class="archive-section" id="archiveSection">
  <div class="archive-title">üì¶ –ê—Ä—Ö–∏–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)</div>
  <div class="products-grid" id="archiveGrid"></div>
</div>

<div class="admin-panel" id="adminPanel">
  <h3>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h3>
  <input type="text" id="productName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
  <input type="text" id="productPrice" placeholder="–¶–µ–Ω–∞ (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)">
  <input type="text" id="productImage" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ">
  <input type="text" id="productCategory" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è">
  <button id="addProductBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabase = createClient(
  'https://qmnnbotyzwftlhwakbnz.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtbm5ib3R5endmdGxod2FrYm56Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwOTE3MzYsImV4cCI6MjA2NzY2NzczNn0.QaHkN4M4_Deh4HN4CZ-spv8QKbGKzhrfGwMvr6Pbyv4'
);

let isAdmin = false;
let selectedCategory = "all";
let allProducts = [];

document.addEventListener('DOMContentLoaded', () => {
  loadProducts();
  setupEventListeners();
});

async function loadProducts() {
  const { data, error } = await supabase.from('products').select('*').order('order', { ascending: true });
  if (error) return alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
  allProducts = data || [];
  updateCategories();
  renderProducts();
}

function updateCategories() {
  const categories = [...new Set(allProducts.map(p => p.category).filter(Boolean))];
  const container = document.getElementById('categories');
  const allButton = container.querySelector('[data-category="all"]');
  container.innerHTML = '';
  container.appendChild(allButton);
  categories.forEach(cat => {
    const btn = document.createElement('button');
    btn.className = 'category-btn';
    btn.dataset.category = cat;
    btn.textContent = cat;
    btn.onclick = () => {
      selectedCategory = cat;
      document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderProducts();
    };
    container.appendChild(btn);
  });
}

function renderProducts() {
  const activeProducts = allProducts.filter(p => !p.archived && (selectedCategory === "all" || p.category === selectedCategory));
  const archivedProducts = allProducts.filter(p => p.archived);

  document.getElementById('productsGrid').innerHTML = activeProducts.map(product => `
    <div class="product-card" data-id="${product.id}">
      <img src="${product.img || 'https://via.placeholder.com/150'}" class="product-image">
      <div class="product-name" contenteditable="${isAdmin}" onblur="updateField(${product.id}, 'name', this.textContent)">${product.name}</div>
      <div class="product-price" contenteditable="${isAdmin}" onblur="updateField(${product.id}, 'price', this.textContent)">${product.price} ‚Ç∏</div>
      ${isAdmin ? `
        <div class="admin-controls">
          <button onclick="archiveProduct(${product.id})">–ê—Ä—Ö–∏–≤</button>
          <button onclick="deleteProduct(${product.id})">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      ` : ''}
    </div>
  `).join('');

  if (isAdmin) {
    document.getElementById('archiveGrid').innerHTML = archivedProducts.map(product => `
      <div class="product-card" data-id="${product.id}">
        <img src="${product.img || 'https://via.placeholder.com/150'}" class="product-image">
        <div class="product-name">${product.name}</div>
        <div class="product-price">${product.price} ‚Ç∏</div>
        <div class="admin-controls">
          <button onclick="restoreProduct(${product.id})">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
          <button onclick="deleteProduct(${product.id})">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    `).join('');
  }
}

window.updateField = async function(id, field, value) {
  const cleaned = field === 'price' ? parseInt(value.replace(/[^\d]/g, '')) || 0 : value.trim();
  if (field === 'price' && cleaned <= 0) return alert('–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0');
  const { error } = await supabase.from('products').update({ [field]: cleaned }).eq('id', id);
  if (error) return alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
  const product = allProducts.find(p => p.id === id);
  if (product) product[field] = cleaned;
  renderProducts();
};

window.archiveProduct = async function(id) {
  if (!confirm('–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä?')) return;
  const { error } = await supabase.from('products').update({ archived: true }).eq('id', id);
  if (error) return alert('–û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏');
  const product = allProducts.find(p => p.id === id);
  if (product) product.archived = true;
  renderProducts();
};

window.restoreProduct = async function(id) {
  const { error } = await supabase.from('products').update({ archived: false }).eq('id', id);
  if (error) return alert('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è');
  const product = allProducts.find(p => p.id === id);
  if (product) product.archived = false;
  renderProducts();
};

window.deleteProduct = async function(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –Ω–∞–≤—Å–µ–≥–¥–∞?')) return;
  const { error } = await supabase.from('products').delete().eq('id', id);
  if (error) return alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
  allProducts = allProducts.filter(p => p.id !== id);
  renderProducts();
};

window.addNewProduct = async function() {
  const name = document.getElementById('productName').value.trim();
  const price = parseInt(document.getElementById('productPrice').value.replace(/[^\d]/g, '')) || 0;
  const img = document.getElementById('productImage').value.trim();
  const category = document.getElementById('productCategory').value.trim();
  if (!name || !price || !category) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');

  const { data, error } = await supabase.from('products').insert([{
    name, price, img: img || 'https://via.placeholder.com/150', category, archived: false, order: allProducts.length + 1
  }]);
  if (error) return alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
  document.getElementById('productName').value = '';
  document.getElementById('productPrice').value = '';
  document.getElementById('productImage').value = '';
  document.getElementById('productCategory').value = '';
  loadProducts();
};

function setupEventListeners() {
  document.getElementById('adminAccess').addEventListener('click', () => {
    const password = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:');
    if (password === 'erema') {
      isAdmin = !isAdmin;
      document.body.classList.toggle('admin-visible', isAdmin);
      renderProducts();
    } else if (password !== null) {
      alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
    }
  });
  document.getElementById('addProductBtn').addEventListener('click', addNewProduct);
  document.querySelector('[data-category="all"]').addEventListener('click', () => {
    selectedCategory = 'all';
    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('[data-category="all"]').classList.add('active');
    renderProducts();
  });
}
</script>
