<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Пайда Все</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }
    header {
      background: white;
      padding: 15px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .contact {
      margin: 10px 0;
    }
    .notice {
      background: #fff8e1;
      padding: 10px;
      margin: 10px;
      border-left: 4px solid #ffc107;
    }
    .categories {
      display: flex;
      overflow-x: auto;
      padding: 10px;
      background: white;
      gap: 10px;
    }
    .category-btn {
      padding: 8px 15px;
      border: none;
      border-radius: 20px;
      background: #f1f1f1;
      cursor: pointer;
      white-space: nowrap;
    }
    .category-btn.active {
      background: #4CAF50;
      color: white;
    }
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      padding: 10px;
    }
    .product-card {
      background: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .product-image {
      width: 100%;
      height: 120px;
      object-fit: contain;
      background: #f8f8f8;
      border-radius: 5px;
    }
    .product-name {
      font-weight: bold;
      margin: 10px 0 5px;
    }
    .product-price {
      color: #2e7d32;
      font-weight: bold;
    }
    .admin-panel {
      background: #f8f9fa;
      padding: 15px;
      margin: 10px;
      border-radius: 10px;
    }
    .admin-controls {
      margin-top: 10px;
      display: flex;
      gap: 5px;
    }
    .admin-controls button {
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .archive-btn {
      background: #ff9800;
      color: white;
    }
    .delete-btn {
      background: #f44336;
      color: white;
    }
    .move-btns {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin-top: 5px;
    }
    [contenteditable="true"] {
      border-bottom: 1px dashed #666;
    }
  </style>
</head>
<body>
  <header>
    <h1>Пайда Все</h1>
    <div class="contact">
      Караганда, ул. Алиханова 37 (цокольный этаж)<br>
      Тел: 8 (778) 085-54-78
    </div>
    <div style="text-align: right;">
      <button id="adminAccess" style="background: none; border: none; color: #f44336; cursor: pointer; text-decoration: underline;">
        Для админа
      </button>
    </div>
  </header>
  
  <div class="notice">
    Заказы после 13:00 обрабатываются на следующий день.<br>
    Доставка и самовывоз доступны по Караганде.
  </div>
  
  <div class="categories" id="categories">
    <button class="category-btn active" data-category="all">Все</button>
  </div>
  
  <div class="products-grid" id="productsGrid"></div>
  
  <div id="adminPanel" style="display: none;">
    <div class="admin-panel">
      <h3>Добавить товар</h3>
      <div style="display: grid; grid-template-columns: 2fr 1fr 2fr 1fr auto; gap: 10px; align-items: center;">
        <input type="text" id="productName" placeholder="Название">
        <input type="text" id="productPrice" placeholder="Цена">
        <input type="text" id="productImage" placeholder="Ссылка на фото">
        <input type="text" id="productCategory" placeholder="Категория">
        <button id="addProductBtn" style="padding: 8px 15px; background: #4CAF50; color: white; border: none; border-radius: 4px;">
          Добавить
        </button>
      </div>
    </div>
    
    <div style="padding: 10px;">
      <h3>Архив (только для админа)</h3>
      <div class="products-grid" id="archiveGrid"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    
    const supabaseUrl = 'https://qmnnbotyzwftlhwakbnz.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtbm5ib3R5endmdGxod2FrYm56Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwOTE3MzYsImV4cCI6MjA2NzY2NzczNn0.QaHkN4M4_Deh4HN4CZ-spv8QKbGKzhrfGwMvr6Pbyv4'
    const supabase = createClient(supabaseUrl, supabaseKey)
    
    let isAdmin = false;
    let selectedCategory = "all";
    let allProducts = [];
    
    document.addEventListener('DOMContentLoaded', () => {
      loadProducts();
      setupEventListeners();
    });

    async function loadProducts() {
      try {
        const { data, error } = await supabase
          .from('products')
          .select('*')
          .order('order', { ascending: true });
        
        if (error) throw error;
        allProducts = data || [];
        updateCategories();
        renderProducts();
      } catch (error) {
        console.error('Ошибка загрузки:', error);
        alert('Ошибка загрузки данных');
      }
    }

    function updateCategories() {
      const categories = [...new Set(allProducts.map(p => p.category).filter(Boolean))];
      const container = document.getElementById('categories');
      
      container.innerHTML = '<button class="category-btn active" data-category="all">Все</button>';
      
      categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'category-btn';
        btn.dataset.category = cat;
        btn.textContent = cat;
        btn.onclick = () => {
          selectedCategory = cat;
          document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          renderProducts();
        };
        container.appendChild(btn);
      });
    }

    function renderProducts() {
      const activeProducts = allProducts.filter(p => !p.archived && (selectedCategory === "all" || p.category === selectedCategory));
      const archivedProducts = allProducts.filter(p => p.archived);
      
      document.getElementById('productsGrid').innerHTML = activeProducts.map(product => `
        <div class="product-card" data-id="${product.id}">
          <img src="${product.img || 'https://via.placeholder.com/150'}" class="product-image">
          <div class="product-name" contenteditable="${isAdmin}" onblur="saveProductChanges(${product.id}, 'name', this.textContent)">
            ${product.name}
          </div>
          <div class="product-price" contenteditable="${isAdmin}" onblur="saveProductChanges(${product.id}, 'price', this.textContent)">
            ${product.price} ₸
          </div>
          ${isAdmin ? `
            <div class="admin-controls">
              <button class="archive-btn" onclick="archiveProduct(${product.id})">Архив</button>
              <button class="delete-btn" onclick="deleteProduct(${product.id})">Удалить</button>
            </div>
            <div class="move-btns">
              <button onclick="moveProduct(${product.id}, 'up')">↑</button>
              <button onclick="moveProduct(${product.id}, 'down')">↓</button>
            </div>
          ` : ''}
        </div>
      `).join('');
      
      if (isAdmin) {
        document.getElementById('archiveGrid').innerHTML = archivedProducts.map(product => `
          <div class="product-card" data-id="${product.id}">
            <img src="${product.img || 'https://via.placeholder.com/150'}" class="product-image">
            <div class="product-name">${product.name}</div>
            <div class="product-price">${product.price} ₸</div>
            <div class="admin-controls">
              <button class="archive-btn" onclick="restoreProduct(${product.id})">Восстановить</button>
              <button class="delete-btn" onclick="deleteProduct(${product.id})">Удалить</button>
            </div>
          </div>
        `).join('');
      }
    }

    async function saveProductChanges(id, field, value) {
      try {
        let updateValue = field === 'price' ? parseInt(value.replace(/\D/g, '')) || 0 : value.trim();
        
        const { error } = await supabase
          .from('products')
          .update({ [field]: updateValue })
          .eq('id', id);
        
        if (error) throw error;
        
        const product = allProducts.find(p => p.id === id);
        if (product) product[field] = updateValue;
        
        renderProducts();
      } catch (error) {
        console.error('Ошибка сохранения:', error);
        alert('Не удалось сохранить изменения');
      }
    }

    async function archiveProduct(id) {
      if (!confirm('Переместить в архив?')) return;
      await updateProductField(id, 'archived', true);
    }

    async function restoreProduct(id) {
      await updateProductField(id, 'archived', false);
    }

    async function deleteProduct(id) {
      if (!confirm('Удалить товар навсегда?')) return;
      
      try {
        const { error } = await supabase
          .from('products')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        allProducts = allProducts.filter(p => p.id !== id);
        renderProducts();
      } catch (error) {
        console.error('Ошибка удаления:', error);
        alert('Ошибка удаления товара');
      }
    }

    async function moveProduct(id, direction) {
      const index = allProducts.findIndex(p => p.id === id);
      if (index === -1) return;
      
      const newIndex = direction === 'up' ? index - 1 : index + 1;
      if (newIndex < 0 || newIndex >= allProducts.length) return;
      
      [allProducts[index].order, allProducts[newIndex].order] = 
        [allProducts[newIndex].order, allProducts[index].order];
      
      allProducts.sort((a, b) => a.order - b.order);
      
      try {
        const updates = allProducts.map((p, i) => ({ id: p.id, order: i + 1 }));
        const { error } = await supabase.from('products').upsert(updates);
        if (error) throw error;
        renderProducts();
      } catch (error) {
        console.error('Ошибка перемещения:', error);
        alert('Ошибка перемещения товара');
      }
    }

    async function addNewProduct() {
      const name = document.getElementById('productName').value.trim();
      const price = parseInt(document.getElementById('productPrice').value.replace(/\D/g, '')) || 0;
      const img = document.getElementById('productImage').value.trim();
      const category = document.getElementById('productCategory').value.trim();
      
      if (!name || !price || !category) {
        alert('Заполните все поля!');
        return;
      }
      
      try {
        const { data, error } = await supabase
          .from('products')
          .insert([{
            name,
            price,
            img: img || 'https://via.placeholder.com/150',
            category,
            order: allProducts.length + 1,
            archived: false
          }])
          .select();
        
        if (error) throw error;
        
        document.getElementById('productName').value = '';
        document.getElementById('productPrice').value = '';
        document.getElementById('productImage').value = '';
        document.getElementById('productCategory').value = '';
        
        loadProducts();
      } catch (error) {
        console.error('Ошибка добавления:', error);
        alert('Ошибка при добавлении товара');
      }
    }

    function setupEventListeners() {
      document.getElementById('adminAccess').onclick = () => {
        const password = prompt('Введите пароль:');
        if (password === "erema") {
          isAdmin = !isAdmin;
          document.getElementById('adminPanel').style.display = isAdmin ? 'block' : 'none';
          renderProducts();
        } else if (password !== null) {
          alert('Неверный пароль!');
        }
      };
      
      document.getElementById('addProductBtn').onclick = addNewProduct;
      
      document.querySelector('[data-category="all"]').onclick = () => {
        selectedCategory = "all";
        document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
        document.querySelector('[data-category="all"]').classList.add('active');
        renderProducts();
      };
    }
  </script>
</body>
</html>
