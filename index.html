<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>Paida All — Каталог</title>
  <style>
    :root {
      --primary-color: #25D366; /* WhatsApp color */
      --admin-color: #ff4757;
      --notice-color: #fff0c4;
      --cart-color: #FF9F43;
      --header-bg: #ffffff;
      --admin-overlay-bg: rgba(255, 255, 255, 0.95);
    }
    
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* Шапка */
    .main-header {
      background: var(--header-bg);
      padding: 15px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: static;
    }
    
    .header-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 15px;
      display: flex;
      flex-direction: column;
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .header-logo {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      text-decoration: none;
    }

    /* Стиль для шапки с изображением */
    .header-banner {
      display: flex;
      align-items: center;
      background: #f0f0f0;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .header-img-container {
      flex: 0 0 150px; /* Увеличил размер фото */
      height: 150px; /* Увеличил размер фото */
    }

    .header-banner-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .header-text-container {
      padding: 15px;
      flex-grow: 1;
    }

    .header-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 5px;
      color: #555;
    }

    .header-description {
      font-size: 14px;
      color: #777;
    }

    /* Основной контент */
    .main-content {
      flex-grow: 1;
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 15px;
      display: flex;
      gap: 20px;
    }

    /* Фильтры */
    .filter-panel {
      flex: 0 0 250px;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .filter-group {
      margin-bottom: 20px;
    }
    
    .filter-group h3 {
      font-size: 16px;
      margin-top: 0;
      margin-bottom: 10px;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
    }
    
    /* Улучшенное меню фильтрации для десктопа */
    .filter-options {
      max-height: 400px; /* Ограничиваем высоту для скролла */
      overflow-y: auto; /* Добавляем вертикальную прокрутку */
      padding-right: 5px; /* Немного места для скроллбара */
    }

    .filter-options::-webkit-scrollbar {
      width: 6px;
    }

    .filter-options::-webkit-scrollbar-thumb {
      background-color: #ccc;
      border-radius: 3px;
    }

    .filter-option-item {
      margin-bottom: 8px;
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .filter-option-item:hover {
      background: #f5f5f5;
    }

    .filter-option-item.active {
      background: var(--primary-color);
      color: #fff;
      font-weight: bold;
    }

    .filter-option-count {
      font-size: 12px;
      background: #eee;
      color: #555;
      padding: 2px 6px;
      border-radius: 10px;
    }

    .filter-option-item.active .filter-option-count {
      background: #fff;
      color: var(--primary-color);
    }

    /* Каталог товаров */
    .product-list {
      flex-grow: 1;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      align-content: flex-start;
    }

    .product-card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: transform 0.2s;
    }

    .product-card:hover {
      transform: translateY(-3px);
    }

    .product-image {
      width: 100%;
      height: 180px;
      object-fit: cover;
      background: #eee;
    }

    .product-info {
      padding: 15px;
      display: flex;
      flex-direction: column;
      flex-grow: 1;
    }

    .product-name {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 5px;
      flex-grow: 1;
    }

    .product-price {
      font-size: 18px;
      color: var(--primary-color);
      margin-bottom: 10px;
      font-weight: bold;
    }

    .add-to-cart-btn {
      background: var(--cart-color);
      color: #fff;
      border: none;
      padding: 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .add-to-cart-btn:hover {
      background: #e08e38;
    }
    
    .add-to-cart-btn.in-cart {
      background: var(--primary-color);
    }
    
    .add-to-cart-btn.in-cart:hover {
      background: #1eab52;
    }
    
    /* Уведомление об отсутствии товаров */
    .no-products {
        text-align: center;
        padding: 50px;
        grid-column: 1 / -1; /* Растягиваем на всю ширину */
        font-size: 18px;
        color: #777;
    }

    /* Плавающие кнопки WhatsApp и Корзина */
    .floating-buttons {
      position: fixed;
      right: 20px;
      bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1000;
    }

    .floating-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      cursor: pointer;
      color: #fff;
      font-size: 24px;
      text-decoration: none;
      transition: transform 0.2s;
    }

    .floating-btn:hover {
      transform: scale(1.05);
    }

    .whatsapp-btn {
      background: var(--primary-color);
    }

    .cart-btn-fixed { /* Сделал корзину рядом с WhatsApp */
      background: var(--cart-color);
      position: relative;
    }
    
    .cart-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--admin-color);
      color: white;
      font-size: 12px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: none; /* Скрыто по умолчанию */
      justify-content: center;
      align-items: center;
      font-weight: bold;
    }

    /* Модальное окно Корзины */
    .cart-modal {
      display: none;
      position: fixed;
      z-index: 1001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }

    .cart-modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      width: 90%;
      max-width: 600px;
      position: relative;
    }

    .cart-modal-content h2 {
      margin-top: 0;
      color: #333;
    }

    .close-btn {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      position: absolute; /* Позиционируем относительно модального окна */
      top: 10px;
      right: 20px;
    }

    .close-btn:hover,
    .close-btn:focus {
      color: #000;
      text-decoration: none;
      cursor: pointer;
    }

    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px dashed #eee;
    }

    .cart-item-name {
      flex: 3;
      font-weight: bold;
    }
    
    .cart-item-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 2;
      justify-content: flex-end;
    }

    .cart-item-quantity, .cart-item-price {
      text-align: right;
    }
    
    .quantity-btn {
        background: #eee;
        border: none;
        width: 25px;
        height: 25px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.2s;
    }

    .quantity-btn:hover {
        background: #ddd;
    }

    .cart-total-line {
      display: flex;
      justify-content: space-between;
      font-size: 18px;
      font-weight: bold;
      padding-top: 15px;
      border-top: 2px solid var(--cart-color);
      margin-top: 15px;
    }

    .checkout-btn {
      width: 100%;
      padding: 15px;
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 20px;
      transition: background 0.2s;
    }

    .checkout-btn:hover {
      background: #1eab52;
    }

    /* Admin Panel */
    .admin-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--admin-overlay-bg);
      backdrop-filter: blur(5px);
      z-index: 2000;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .admin-panel {
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      width: 90%;
      max-width: 500px;
    }

    .admin-panel h2 {
      color: var(--admin-color);
      border-bottom: 2px solid var(--admin-color);
      padding-bottom: 10px;
    }

    .admin-group {
      margin-bottom: 15px;
    }

    .admin-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .admin-group input, .admin-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    .admin-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .admin-btn {
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }

    .admin-save-btn {
      background: var(--primary-color);
      color: #fff;
    }

    .admin-cancel-btn {
      background: #eee;
      color: #333;
    }
    
    /* Мобильные стили */
    @media (max-width: 768px) {
      .main-content {
        flex-direction: column;
        gap: 10px;
        margin: 10px auto;
      }

      .filter-panel {
        flex: none;
        width: 100%;
        padding: 15px;
      }

      .product-list {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
      
      .header-img-container {
        flex: 0 0 100px;
        height: 100px;
      }
      
      .header-title {
        font-size: 18px;
      }

      .header-description {
        font-size: 12px;
      }

      .floating-buttons {
        right: 10px;
        bottom: 10px;
        gap: 5px;
      }
      
      .floating-btn {
        width: 45px;
        height: 45px;
        font-size: 20px;
      }
      
      .cart-modal-content {
          margin: 5% auto;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

  <header class="main-header">
    <div class="header-container">
      <div class="header-content">
        <a href="#" class="header-logo">Paida All</a>
        </div>
      <div class="header-banner">
        <div class="header-img-container">
          <img id="headerImage" class="header-banner-img" src="https://via.placeholder.com/150/FF9F43/FFFFFF?text=PROMO" alt="Промо-баннер">
        </div>
        <div class="header-text-container">
          <h1 id="headerTitle" class="header-title">Специальные Предложения</h1>
          <p id="headerDescription" class="header-description">Лучшие цены на товары для дома и семьи. Доставка по Казахстану!</p>
        </div>
      </div>
      <button id="openAdminPanel" class="add-to-cart-btn" style="background: var(--admin-color); margin-top: 10px; display: none;">Редактировать Шапку (Admin)</button>
    </div>
  </header>

  <div class="main-content">
    
    <aside class="filter-panel">
      <h2>Фильтр</h2>
      
      <div class="filter-group">
        <h3>Производитель</h3>
        <div id="manufacturerFilters" class="filter-options">
          </div>
      </div>
      
      <div class="filter-group">
        <h3>Категория</h3>
        <div id="categoryFilters" class="filter-options">
          </div>
      </div>
      
       <div class="filter-group" id="subCategoryGroup" style="display: none;">
        <h3>Тип Продукта</h3>
        <div id="subCategoryFilters" class="filter-options">
          </div>
      </div>
      
    </aside>

    <main class="product-list" id="productList">
      </main>

  </div>

  <div class="floating-buttons">
    <div id="cartBtnFixed" class="floating-btn cart-btn-fixed">
      <i class="fas fa-shopping-cart"></i>
      <span id="cartBadge" class="cart-badge">0</span>
    </div>
    <a href="https://wa.me/77073105739" class="floating-btn whatsapp-btn" target="_blank">
      <i class="fab fa-whatsapp"></i>
    </a>
  </div>

  <div id="cartModal" class="cart-modal">
    <div class="cart-modal-content">
      <span class="close-btn">&times;</span>
      <h2>Ваша Корзина</h2>
      
      <div id="cartItems">
        </div>
      
      <div class="cart-total-line">
        <span>Итого:</span>
        <span id="cartTotal">0 ₸</span>
      </div>
      
      <button id="checkoutBtn" class="checkout-btn">Оформить заказ через WhatsApp</button>
    </div>
  </div>

  <div id="adminOverlay" class="admin-overlay">
      <div class="admin-panel">
          <h2>Редактирование Шапки</h2>
          <div class="admin-group">
              <label for="adminTitle">Заголовок (H1)</label>
              <input type="text" id="adminTitle" value="">
          </div>
          <div class="admin-group">
              <label for="adminDescription">Описание (P)</label>
              <textarea id="adminDescription"></textarea>
          </div>
          <div class="admin-group">
              <label for="adminImage">URL Изображения</label>
              <input type="text" id="adminImage" value="">
              <small>Для сохранения на хосте, замените URL изображения напрямую в коде или используйте серверную часть.</small>
          </div>
          <div class="admin-actions">
              <button id="adminCancelBtn" class="admin-btn admin-cancel-btn">Отмена</button>
              <button id="adminSaveBtn" class="admin-btn admin-save-btn">Применить (Только для сессии)</button>
          </div>
      </div>
  </div>

  <script>
    // --- 1. ДАННЫЕ ПРОДУКТОВ (Обновленная структура для многоуровневой фильтрации) ---
    // Добавлены поля `category` и `subCategory`
    const allProducts = [
      { id: 1, name: "Мыло Dove", price: 500, manufacturer: "Unilever", category: "Гигиена", subCategory: "Мыло", image: "https://via.placeholder.com/200/4ECDC4/FFFFFF?text=Dove" },
      { id: 2, name: "Зубная паста R.O.C.S.", price: 1200, manufacturer: "R.O.C.S.", category: "Гигиена", subCategory: "Зубные пасты", image: "https://via.placeholder.com/200/556270/FFFFFF?text=ROCS" },
      { id: 3, name: "Детский крем 'Весна'", price: 350, manufacturer: "АО 'Весна'", category: "Детские товары", subCategory: "Кремы", image: "https://via.placeholder.com/200/FF6B6B/FFFFFF?text=Дет.Крем" },
      { id: 4, name: "Шампунь Head&Shoulders", price: 1800, manufacturer: "Procter & Gamble", category: "Гигиена", subCategory: "Шампуни", image: "https://via.placeholder.com/200/C7F464/FFFFFF?text=H%26S" },
      { id: 5, name: "Подгузники Pampers", price: 4500, manufacturer: "Procter & Gamble", category: "Детские товары", subCategory: "Подгузники", image: "https://via.placeholder.com/200/555B6E/FFFFFF?text=Pampers" },
      { id: 6, name: "Зубная паста 'Весна' детская", price: 600, manufacturer: "АО 'Весна'", category: "Детские товары", subCategory: "Зубные пасты", image: "https://via.placeholder.com/200/A0DAA9/FFFFFF?text=Весна+Дет." },
      { id: 7, name: "Чистящее средство Comet", price: 900, manufacturer: "Procter & Gamble", category: "Бытовая химия", subCategory: "Уборка", image: "https://via.placeholder.com/200/FAD089/FFFFFF?text=Comet" },
      { id: 8, name: "Гель для душа Palmolive", price: 750, manufacturer: "Colgate-Palmolive", category: "Гигиена", subCategory: "Гели для душа", image: "https://via.placeholder.com/200/69D2E7/FFFFFF?text=Palmolive" },
      { id: 9, name: "Мыло Safeguard", price: 550, manufacturer: "Procter & Gamble", category: "Гигиена", subCategory: "Мыло", image: "https://via.placeholder.com/200/FFCC99/FFFFFF?text=Safeguard" },
      { id: 10, name: "Детское мыло 'Алиса'", price: 250, manufacturer: "Невская Косметика", category: "Детские товары", subCategory: "Мыло", image: "https://via.placeholder.com/200/96A8A4/FFFFFF?text=Алиса+Мыло" },
      { id: 11, name: "Ватные диски", price: 200, manufacturer: "Разное", category: "Аксессуары", subCategory: "Прочее", image: "https://via.placeholder.com/200/D0E7FF/FFFFFF?text=Диски" },
      { id: 12, name: "Лак для волос Taft", price: 1100, manufacturer: "Henkel", category: "Косметика", subCategory: "Укладка", image: "https://via.placeholder.com/200/F08080/FFFFFF?text=Taft" },
      // Добавим больше от 'АО 'Весна'' для тестирования
      { id: 13, name: "Туалетное мыло 'Весна'", price: 400, manufacturer: "АО 'Весна'", category: "Гигиена", subCategory: "Мыло", image: "https://via.placeholder.com/200/F5A9A9/FFFFFF?text=Весна+Мыло" },
      { id: 14, name: "Стиральный порошок 'Весна'", price: 1500, manufacturer: "АО 'Весна'", category: "Бытовая химия", subCategory: "Стирка", image: "https://via.placeholder.com/200/A9A9F5/FFFFFF?text=Весна+Порошок" },
      { id: 15, name: "Детское мыло 'Весна'", price: 300, manufacturer: "АО 'Весна'", category: "Детские товары", subCategory: "Мыло", image: "https://via.placeholder.com/200/A9F5A9/FFFFFF?text=Весна+Дет.+Мыло" },
      { id: 16, name: "Взрослая зубная паста 'Весна'", price: 800, manufacturer: "АО 'Весна'", category: "Гигиена", subCategory: "Зубные пасты", image: "https://via.placeholder.com/200/F5F5A9/FFFFFF?text=Весна+ЗП" },
    ];

    // --- 2. ПЕРЕМЕННЫЕ СОСТОЯНИЯ ---
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    let selectedManufacturer = 'all';
    let selectedCategory = 'all';
    let selectedSubCategory = 'all';
    
    // Переменные для состояния шапки (для админ-панели)
    let headerState = {
        title: document.getElementById('headerTitle').textContent,
        description: document.getElementById('headerDescription').textContent,
        image: document.getElementById('headerImage').src
    };

    // --- 3. ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ---

    /**
     * Получает IP пользователя для добавления в заказ (имитация)
     */
    async function getIP() {
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            const data = await response.json();
            return data.ip || 'Неизвестен';
        } catch (error) {
            console.error('Ошибка получения IP:', error);
            return 'Неизвестен';
        }
    }
    
    /**
     * Фильтрует список продуктов на основе текущих выбранных фильтров.
     * @returns {Array} Отфильтрованный список продуктов.
     */
    function getFilteredProducts() {
        return allProducts.filter(product => {
            const manMatch = selectedManufacturer === 'all' || product.manufacturer === selectedManufacturer;
            const catMatch = selectedCategory === 'all' || product.category === selectedCategory;
            const subCatMatch = selectedSubCategory === 'all' || product.subCategory === selectedSubCategory;
            
            return manMatch && catMatch && subCatMatch;
        });
    }
    
    // --- 4. ЛОГИКА КОРЗИНЫ (Улучшенная) ---

    function addToCart(productId) {
      const product = allProducts.find(p => p.id === productId);
      if (!product) return;

      const existingItem = cart.find(item => item.id === productId);

      if (existingItem) {
        existingItem.quantity += 1;
      } else {
        cart.push({ id: productId, name: product.name, price: product.price, quantity: 1 });
      }

      localStorage.setItem('cart', JSON.stringify(cart));
      updateCartUI();
      updateProductList(); // Обновить кнопку "В корзине"
    }
    
    function changeQuantity(productId, delta) {
        const itemIndex = cart.findIndex(item => item.id === productId);
        
        if (itemIndex > -1) {
            cart[itemIndex].quantity += delta;
            
            if (cart[itemIndex].quantity <= 0) {
                cart.splice(itemIndex, 1); // Удаляем, если количество <= 0
            }
            
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartUI();
            updateProductList(); // Обновить кнопку "В корзине"
        }
    }
    
    function removeFromCart(productId) {
        cart = cart.filter(item => item.id !== productId);
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartUI();
        updateProductList(); // Обновить кнопку "В корзине"
    }

    async function checkout() {
        if (cart.length === 0) {
            alert('Ваша корзина пуста!');
            return;
        }

        const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        const ip = await getIP();
        
        // Формирование сообщения для WhatsApp
        const messageHeader = `*НОВЫЙ ЗАКАЗ* (IP: ${ip})`;
        const messageItems = cart.map(item => 
            `\n- ${item.name} (${item.price.toLocaleString('ru-RU')} ₸) x ${item.quantity} = ${(item.price * item.quantity).toLocaleString('ru-RU')} ₸`
        ).join('');
        const messageTotal = `\n\n*ИТОГО:* ${total.toLocaleString('ru-RU')} ₸`;
        
        const whatsappMessage = encodeURIComponent(messageHeader + messageItems + messageTotal);
        
        // Номер WhatsApp администратора
        const adminWhatsapp = '77073105739'; 
        
        // Открываем WhatsApp
        window.open(`https://wa.me/${adminWhatsapp}?text=${whatsappMessage}`, '_blank');
        
        // Очистка корзины после отправки (по желанию, можно и не очищать)
        // cart = [];
        // localStorage.setItem('cart', JSON.stringify(cart));
        // updateCartUI();
        // document.getElementById('cartModal').style.display = 'none';
        
        // Оставим корзину открытой, но добавим сообщение
        alert('Заказ отправлен в WhatsApp. Пожалуйста, подтвердите его отправку.');
    }
    
    function updateCartUI() {
      const cartItems = document.getElementById('cartItems');
      const cartTotal = document.getElementById('cartTotal');
      const cartBadge = document.getElementById('cartBadge');
      const cartModal = document.getElementById('cartModal');
      
      // Показываем/скрываем бейдж
      if (cart.length > 0) {
        cartBadge.style.display = 'flex';
        cartBadge.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
      } else {
        cartBadge.style.display = 'none';
      }
      
      // Обновляем список товаров
      if (cart.length === 0) {
          cartItems.innerHTML = '<p style="text-align: center; color: #777;">Корзина пуста.</p>';
          document.getElementById('checkoutBtn').disabled = true;
          document.getElementById('checkoutBtn').textContent = 'Корзина пуста';
      } else {
          cartItems.innerHTML = cart.map(item => {
            return `
              <div class="cart-item">
                <div class="cart-item-name">${item.name}</div>
                <div class="cart-item-controls">
                    <button class="quantity-btn" onclick="changeQuantity(${item.id}, -1)">-</button>
                    <div class="cart-item-quantity">${item.quantity} шт.</div>
                    <button class="quantity-btn" onclick="changeQuantity(${item.id}, 1)">+</button>
                    <div class="cart-item-price">${(item.price * item.quantity).toLocaleString('ru-RU')} ₸</div>
                </div>
              </div>
            `;
          }).join('');
          
          document.getElementById('checkoutBtn').disabled = false;
          document.getElementById('checkoutBtn').textContent = 'Оформить заказ через WhatsApp';
      }

      // Обновляем итоговую сумму
      const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
      cartTotal.textContent = `${total.toLocaleString('ru-RU')} ₸`;
      
      // Добавляем обработчики для модального окна (открытие/закрытие)
      document.getElementById('cartBtnFixed').onclick = () => {
          cartModal.style.display = 'block';
      };
      
      document.querySelector('.close-btn').onclick = () => {
          cartModal.style.display = 'none';
      };
      
      window.onclick = (event) => {
          if (event.target === cartModal) {
              cartModal.style.display = 'none';
          }
      };
    }
    
    // --- 5. ЛОГИКА ФИЛЬТРАЦИИ (Многоуровневая) ---

    /**
     * Создает структуру для фильтров
     * @param {string} filterType - 'manufacturer', 'category', 'subCategory'
     */
    function renderFilters(filterType) {
        let uniqueItems = new Set();
        let counts = {};
        
        let filteredProducts = getFilteredProducts().filter(p => {
            // Если мы рендерим категории, игнорируем текущую категорию при фильтрации
            if (filterType === 'category') {
                return (selectedManufacturer === 'all' || p.manufacturer === selectedManufacturer);
            }
            // Если мы рендерим подкатегории, берем только те, что соответствуют категории
            if (filterType === 'subCategory') {
                return (selectedManufacturer === 'all' || p.manufacturer === selectedManufacturer) && p.category === selectedCategory;
            }
            // Для производителя, берем все
            return true;
        });

        // 1. Сбор уникальных значений и подсчет
        filteredProducts.forEach(product => {
            const value = product[filterType];
            if (value) {
                uniqueItems.add(value);
                counts[value] = (counts[value] || 0) + 1;
            }
        });
        
        // 2. Добавляем "Все" и сортируем
        const sortedItems = Array.from(uniqueItems).sort();
        sortedItems.unshift('all');

        // 3. Выбор контейнера и текущего активного фильтра
        let container, currentSelected;
        if (filterType === 'manufacturer') {
            container = document.getElementById('manufacturerFilters');
            currentSelected = selectedManufacturer;
        } else if (filterType === 'category') {
            container = document.getElementById('categoryFilters');
            currentSelected = selectedCategory;
        } else if (filterType === 'subCategory') {
            container = document.getElementById('subCategoryFilters');
            currentSelected = selectedSubCategory;
        } else {
            return;
        }

        // 4. Рендеринг HTML
        container.innerHTML = sortedItems.map(item => {
            const itemName = item === 'all' ? (filterType === 'manufacturer' ? 'Все производители' : 'Все категории') : item;
            const isActive = item === currentSelected ? 'active' : '';
            const count = item === 'all' ? filteredProducts.length : counts[item] || 0;
            
            // Если текущий фильтр не 'all' и для него нет товаров, не рендерим его, кроме "Все"
            if (item !== 'all' && count === 0 && selectedManufacturer === 'all' && selectedCategory === 'all') return ''; // Предотвращение рендеринга пустых категорий при отсутствии фильтров

            return `
                <div class="filter-option-item ${isActive}" onclick="selectFilter('${filterType}', '${item}')">
                    <span>${itemName}</span>
                    <span class="filter-option-count">${count}</span>
                </div>
            `;
        }).join('');
        
        // 5. Логика отображения подкатегорий
        const subCategoryGroup = document.getElementById('subCategoryGroup');
        if (filterType === 'subCategory') {
             // Если выбрана конкретная категория И есть подкатегории, показываем группу
             if (selectedCategory !== 'all' && sortedItems.length > 1) { 
                 subCategoryGroup.style.display = 'block';
             } else {
                 subCategoryGroup.style.display = 'none';
             }
        }
    }

    /**
     * Обрабатывает выбор фильтра
     * @param {string} filterType - 'manufacturer', 'category', 'subCategory'
     * @param {string} value - Выбранное значение
     */
    function selectFilter(filterType, value) {
        if (filterType === 'manufacturer') {
            selectedManufacturer = value;
            // При смене производителя, сбросить категорию и подкатегорию, как запрашивалось
            selectedCategory = 'all';
            selectedSubCategory = 'all';
        } else if (filterType === 'category') {
            selectedCategory = value;
            // При смене категории, сбросить подкатегорию
            selectedSubCategory = 'all';
        } else if (filterType === 'subCategory') {
            selectedSubCategory = value;
        }

        // Обновляем фильтры, зависящие друг от друга
        renderFilters('manufacturer');
        renderFilters('category');
        renderFilters('subCategory');
        
        updateProductList();
    }
    
    // --- 6. РЕНДЕРИНГ СПИСКА ТОВАРОВ ---

    function updateProductList() {
      const productList = document.getElementById('productList');
      const products = getFilteredProducts();

      if (products.length === 0) {
          productList.innerHTML = '<div class="no-products">⚠️ Товаров по выбранным фильтрам не найдено. Попробуйте сбросить некоторые фильтры.</div>';
          return;
      }
      
      productList.innerHTML = products.map(product => {
        const isInCart = cart.some(item => item.id === product.id);
        const btnClass = isInCart ? 'in-cart' : '';
        const btnText = isInCart ? 'В корзине (+1)' : 'В корзину';
        
        return `
          <div class="product-card">
            <img src="${product.image}" alt="${product.name}" class="product-image">
            <div class="product-info">
              <div class="product-name">${product.name}</div>
              <div class="product-meta" style="font-size: 12px; color: #999;">${product.manufacturer} | ${product.category}</div>
              <div class="product-price">${product.price.toLocaleString('ru-RU')} ₸</div>
              <button class="add-to-cart-btn ${btnClass}" onclick="addToCart(${product.id})">${btnText}</button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // --- 7. ЛОГИКА АДМИН-ПАНЕЛИ (Редактирование шапки) ---

    function checkAdminMode() {
        const urlParams = new URLSearchParams(window.location.search);
        const isAdmin = urlParams.get('admin') === 'true';
        
        if (isAdmin) {
            document.getElementById('openAdminPanel').style.display = 'block';
            
            // Загрузка текущих значений в панель
            document.getElementById('adminTitle').value = headerState.title;
            document.getElementById('adminDescription').value = headerState.description;
            document.getElementById('adminImage').value = headerState.image;

            // Обработчики открытия/закрытия
            document.getElementById('openAdminPanel').onclick = () => {
                document.getElementById('adminOverlay').style.display = 'flex';
            };
            
            document.getElementById('adminCancelBtn').onclick = () => {
                document.getElementById('adminOverlay').style.display = 'none';
            };
            
            // Обработчик сохранения
            document.getElementById('adminSaveBtn').onclick = () => {
                headerState.title = document.getElementById('adminTitle').value;
                headerState.description = document.getElementById('adminDescription').value;
                headerState.image = document.getElementById('adminImage').value;
                
                // Применение изменений к шапке
                document.getElementById('headerTitle').textContent = headerState.title;
                document.getElementById('headerDescription').textContent = headerState.description;
                document.getElementById('headerImage').src = headerState.image;
                
                document.getElementById('adminOverlay').style.display = 'none';
                alert('Изменения применены (только для этой сессии. Для постоянного сохранения нужен сервер).');
            };
        }
    }

    // --- 8. ИНИЦИАЛИЗАЦИЯ ---

    document.addEventListener('DOMContentLoaded', () => {
      // Инициализация корзины и списка товаров
      updateCartUI();
      
      // Инициализация фильтров
      renderFilters('manufacturer');
      renderFilters('category');
      renderFilters('subCategory');
      
      // Первичный рендеринг списка товаров
      updateProductList();
      
      // Настройка кнопки оформления заказа
      document.getElementById('checkoutBtn').addEventListener('click', checkout);
      
      // Проверка режима администрирования
      checkAdminMode();
    });
  </script>
</body>
</html>
